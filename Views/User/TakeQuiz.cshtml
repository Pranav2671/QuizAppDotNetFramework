@model List<QuizAppDotNetFramework.Models.QuestionModel>

@{
    ViewBag.Title = "Take Quiz";
    Layout = "~/Views/Shared/_Layout.cshtml";

    int timeLimitMinutes = (ViewBag.TimeLimit != null) ? (int)ViewBag.TimeLimit : 0;
    int totalSeconds = timeLimitMinutes * 60;
}

<div class="container mt-4">
    <h2>Take Quiz</h2>

    <div class="alert alert-info">
        Time Remaining: <span id="timer" style="font-weight:bold;">@((timeLimitMinutes > 0) ? timeLimitMinutes + ":00" : "00:00")</span>
    </div>

    @using (Html.BeginForm("SubmitQuiz", "User", FormMethod.Post, new { id = "quizForm", @onsubmit = "return onSubmitQuiz();" }))
    {
        @Html.AntiForgeryToken()
        <input type="hidden" name="QuizID" value="@ViewBag.QuizId" />
        <input type="hidden" name="ElapsedSeconds" id="ElapsedSeconds" value="0" />

        for (int i = 0; i < Model.Count; i++)
        {
            var q = Model[i];
            <div class="card mb-3">
                <div class="card-body">
                    <p><strong>Q@(i+1):</strong> @q.QuestionText</p>

                    <input type="hidden" name="answers[@q.QuestionId]" value="NA" />

                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="answers[@q.QuestionId]" id="@q.QuestionId-OptionA" value="A" />
                        <label class="form-check-label" for="@q.QuestionId-OptionA">@q.OptionA</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="answers[@q.QuestionId]" id="@q.QuestionId-OptionB" value="B" />
                        <label class="form-check-label" for="@q.QuestionId-OptionB">@q.OptionB</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="answers[@q.QuestionId]" id="@q.QuestionId-OptionC" value="C" />
                        <label class="form-check-label" for="@q.QuestionId-OptionC">@q.OptionC</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="answers[@q.QuestionId]" id="@q.QuestionId-OptionD" value="D" />
                        <label class="form-check-label" for="@q.QuestionId-OptionD">@q.OptionD</label>
                    </div>
                </div>
            </div>
        }

        <button id="submitBtn" type="submit" class="btn btn-success">Submit Quiz</button>
    }
</div>

@section scripts {
    <script>
    var totalTime = @totalSeconds;
    if (isNaN(totalTime) || totalTime <= 0) totalTime = 0;

    var timeLeft = totalTime;
    var timerInterval = null;
    var timerElement = document.getElementById("timer");

    function formatTime(s) {
        var mins = Math.floor(s / 60);
        var secs = s % 60;
        return (mins < 10 ? "0" : "") + mins + ":" + (secs < 10 ? "0" : "") + secs;
    }

    function updateTimer() {
        if (timeLeft <= 0) {
            timerElement.innerText = "00:00";
            clearInterval(timerInterval);

            document.getElementById("ElapsedSeconds").value = totalTime;
            document.getElementById("submitBtn").disabled = true;

            var form = document.getElementById("quizForm");
            if (form) form.submit();
            return;
        }

        if (timeLeft <= 30) {
            timerElement.style.color = "red";
            timerElement.style.fontWeight = "bold";
        }

        timerElement.innerText = formatTime(timeLeft);
        timeLeft--;
    }

    function onSubmitQuiz() {
        clearInterval(timerInterval);
        var elapsed = totalTime - timeLeft;
        if (elapsed < 0) elapsed = 0;
        document.getElementById("ElapsedSeconds").value = elapsed;

        document.getElementById("submitBtn").disabled = true;
        return true;
    }

    if (totalTime > 0) {
        timerInterval = setInterval(updateTimer, 1000);
        updateTimer();
    } else {
        timerElement.innerText = "No timer";
    }
    </script>
}
